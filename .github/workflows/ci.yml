name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # Fast checks (runs on every push)
  quick-checks:
    name: Quick Checks (Lint & Format)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install linting tools
        run: |
          pip install ruff black

      - name: Run Ruff
        run: ruff check src tests

      - name: Run Black
        run: black --check src tests

  # Unit tests (fast, no Docker required)
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quick-checks
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run unit tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest tests/unit/ -v --cov=src --cov-report=term || echo "No unit tests found"

  # Integration tests (slow, only on PR to main or manual trigger)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    # Only run on PRs to main, or manual workflow dispatch
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          docker system prune -af

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest

      - name: Start Docker services
        run: |
          docker compose -f docker/docker-compose.yml up -d weaviate postgres
          sleep 15

      - name: Run integration tests
        env:
          PYTHONPATH: ${{ github.workspace }}
          WEAVIATE_URL: http://localhost:8080
        run: |
          pytest tests/integration/ -v --maxfail=3 || echo "No integration tests found"

      - name: Cleanup
        if: always()
        run: docker compose -f docker/docker-compose.yml down -v